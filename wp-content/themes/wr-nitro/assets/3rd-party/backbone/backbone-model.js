var optimizeCb=function(t,e,n){if(void 0===e)return t;switch(null==n?3:n){case 1:return function(n){return t.call(e,n)};case 2:return function(n,i){return t.call(e,n,i)};case 3:return function(n,i,r){return t.call(e,n,i,r)};case 4:return function(n,i,r,s){return t.call(e,n,i,r,s)}}return function(){return t.apply(e,arguments)}},cb=function(t,e,n){return null==t?_.identity:_.isFunction(t)?optimizeCb(t,e,n):_.isObject(t)?_.matcher(t):_.property(t)};_.mixin({mapObject:function(t,e,n){e=cb(e,n);for(var i,r=_.keys(t),s=r.length,a={},o=0;s>o;o++)i=r[o],a[i]=e(t[i],i,t);return a}}),_.noop=function(){},void function(t,e){if("function"==typeof define&&define.amd)define(["underscore","backbone","exports"],function(n,i,r){t.B=e(t,r,n,i)});else if("undefined"!=typeof exports){var n=require("underscore"),i=require("backbone");e(t,exports,n,i)}else t.B=e(t,t.B||{},t._,t.Backbone)}(this,function(t,e,n,i){function r(t,e){if(t.computes&&t.computes[e]){var i=t.computes[e],s=n(i.deps).map(function(e){return r(t,e)});return i.get.apply(t,s)}return t.attributes[e]}function s(t,e){if(!t||!e)return!1;for(var n=!1,i=t.prototype;i;){if(i==e.prototype){n=!0;break}i=i.__proto__}return n}var a,o,c,u=i.Model,h=i.Collection;return c=e.Compute=function(){function t(e,i){return this instanceof t?(i=n.isArray(e)&&n.isFunction(i)?{deps:e,get:i}:n.isFunction(e)?n.defaults({get:e},i):e||{},void n.defaults(this,i,{deps:[],init:function(){return null},get:function(t){return t},set:function(t){return t}})):new t(e,i)}return t}(),a=e.Model=function(){function t(e,i){return this instanceof t?(n.extend(this,n.pick(i,"_parent","_relatedKey")),n.each(this.computes,this._registerComputeValue,this),Object.defineProperties(this,{root:{get:function(){for(var t=this,e=this.collection||this._parent;e;)t=e,e=e.collection||e._parent;return t}}}),void u.apply(this,arguments)):s(e,t)?e.create.apply(e,n(arguments).slice(1)):t.create.apply(t,arguments)}return t.prototype.__proto__=u.prototype,n.extend(t.prototype,{relations:{},computes:{},defaults:{},get:function(t){for(var e,n=this,i=/(\w+)(?:\[([0-9]+)\])?/g;e=i.exec(t);)n=n instanceof u?r(n,e[1]):"object"==typeof n?n[e[1]]:void 0,e[2]&&(n=n instanceof h?n.at(e[2]):n[e[2]]);return n},setRelation:function(e,i,r){var s=this.attributes[e],a=this.idAttribute||"id",c=[],u=[];if(r.unset&&s&&delete s.parent,this.relations&&n.has(this.relations,e)){if(s&&s instanceof o)return i instanceof o||i instanceof Array?(i=i.models||i,c=n.clone(i),s.each(function(t,e){if("undefined"!=typeof t[a]){var r=n.find(i,function(e){return e[a]===t[a]});r?(t.set(r.toJSON?r.toJSON():r),c.splice(e,1)):u.push(t)}}),n.each(u,function(t){s.remove(t)}),s.add(c)):s.each(function(t){i[a]===t[a]?t.set(i):s.remove(t)}),s;if(i instanceof t&&(i=i.toJSON()),s&&s instanceof t)return s.set(i),s;r._parent=this,r._relatedKey=e,i=new this.relations[e](i,r),i.parent=this}return i},set:function(t,e,n){if("object"==typeof t)return n=e,this._set(t,n);if("string"==typeof t){if(!t.match(/[.\[]/))return this._set(t,e,n);var i=/(\w+)(?:\[([0-9]+)\])?/,r=t.split("."),s=r.pop().match(i),a=r.join(".");if(!s[2]){var o=this.get(a);return o instanceof u?o.set(s[1],e,n):"object"==typeof o&&(o[s[1]]=e),this}var c=this.get(a+"."+s[1]);return c instanceof h?c.at(parseInt(s[2])).set(e,n):"object"==typeof o&&(c[parseInt(s[2])]=e),this}},_set:function(t,e,i){var r,s,a,o,c,u,h,f;if(null==t)return this;if("object"==typeof t?(s=t,i=e):(s={})[t]=e,i||(i={}),!this._validate(s,i))return!1;a=i.unset,c=i.silent,o=[],u=this._changing,this._changing=!0,u||(this._previousAttributes=n.clone(this.attributes),this.changed={}),f=this.attributes,h=this._previousAttributes,this.idAttribute in s&&(this.id=s[this.idAttribute]);for(r in s)this.computes[r]?(e=s[r],e=this.computes[r].set.call(this,e,i)):(e=s[r],e=this.setRelation(r,e,i)),n.isEqual(f[r],e)||o.push(r),n.isEqual(h[r],e)?delete this.changed[r]:this.changed[r]=e,a?delete f[r]:f[r]=e;if(!c){o.length&&(this._pending=!0);for(var d=0,l=o.length;l>d;d++)this.trigger("change:"+o[d],this,f[o[d]],i)}if(u)return this;if(!c)for(;this._pending;)this._pending=!1,this.trigger("change",this,i),this._triggerParentChange(i);return this._pending=!1,this._changing=!1,this},clone:function(t){return new this.constructor(this.toJSON())},clear:function(t){var e={};for(var i in this.attributes)this.attributes[i]instanceof u?this.attributes[i].clear(t):this.attributes[i]instanceof h?(this.attributes[i].invoke("clear",t),this.attributes[i].reset([])):e[i]=void 0;return this.set(e,n.extend({},t,{unset:!0}))},toJSON2:function(t){var e=n.clone(this.attributes);return e.__proto__=null,n.each(this.relations,function(t,i){n.has(e,i)?e[i]=e[i].toJSON():e[i]=(new t).toJSON()}),e},toJSON:function(){var t,e=Object.create(null,{});for(var i in this.attributes)t=this.attributes[i],(t instanceof u||t instanceof h)&&(t=t.toJSON()),t instanceof c&&(t=t.get.call(this)),n.isObject(t)&&(t=n.clone(t)),e[i]=t;return e},toCompactJSON:function(){var e,i=Object.create(null,{});for(var r in this.attributes)if(this.attributes.hasOwnProperty(r)){if(e=this.attributes[r],e instanceof t||e instanceof o?e=e.toCompactJSON():(e instanceof u||e instanceof h)&&(e=e.toJSON()),e instanceof c)continue;if(n.isEqual(e,this.defaults[r]))continue;i[r]=e}return i},_triggerParentChange:function(t){var e=this._parent;if(e){e.changed={},n.extend(t,{chained:!0});for(var i in this.changed)e.changed[this._relatedKey+"."+i]=this.changed[i],e.trigger("change:"+this._relatedKey+"."+i,e,this.changed[i],t);e.changed[this._relatedKey]=void 0,e.trigger("change:"+this._relatedKey,e,this,t),e.trigger("change",e,t),e._triggerParentChange(t)}},_registerComputeValue:function(t,e){n.each(t.deps,function(t){this.on("change:"+t,function(i,r,s){var r=i.get(t);r instanceof u||r instanceof o?(i.changed[e]=void 0,n.each(r.changed,function(t,n){i.changed[n]=t,i.trigger("change:"+e+"."+n,i,t,s)})):i.changed[e]=r,i.trigger("change:"+e,i,r,s),i.trigger("change",i,s)})},this)},alias:function(e){for(var i in e.attributes)e.attributes[i]instanceof u&&(this.attributes.hasOwnProperty(i)&&this.attributes[i]instanceof u&&this.attributes[i]instanceof h||(this.attributes[i]=new t(this.attributes[i],{_parent:this,_relatedKey:i})),this.attributes[i].alias(e.attributes[i]));return this._alias=e,this.attributes.__proto__=e.attributes,this.defaults=n.extend({},e.defaults,this.defaults),this.relations=n.extend({},e.relations,this.relations),this.computes=n.extend({},e.computes,this.computes),this}}),n.extend(t,{create:function(e,i,r){var i=i||{},r=r||{},a=n.extend({},this.prototype.defaults,i.defaults,e),o=n.extend({},this.prototype.relations,i.relations),f=n.extend({},this.prototype.computes,i.computes);for(var d in e)s(e[d],u)?(o[d]=e[d],a[d]={}):s(e[d],h)?(o[d]=e[d],a[d]=[]):e[d]instanceof c&&(f[d]=e[d],delete a[d]);return this.extend(n.extend({},i,{defaults:a,relations:o,computes:f}),n.extend({},r,{create:t.create,extend:t.extend,define:t.define}))},extend:function(){return u.extend.apply(this,arguments)}}),t.define=t.create,t}(),o=e.Collection=function(){function t(e,i){return this instanceof t?(n.extend(this,n.pick(i,"_parent","_relatedKey")),this.on("change",this._triggerParentChange),this.on("add",this._triggerParentChange),this.on("remove",this._triggerParentChange),void h.apply(this,arguments)):s(e,t)?e.create.apply(e,n(arguments).slice(1)):t.create.apply(t,arguments)}return t.prototype.__proto__=h.prototype,n.extend(t.prototype,{model:a,_triggerParentChange:function(t,e){var i=this._parent;if(i){if(t&&t.collection){var r=t.collection.indexOf(t);i.changed={},n.extend(e,{chained:!0});for(var s in t.changed)i.changed[this._relatedKey+"["+r+"]."+s]=t.changed[s],i.trigger("change:"+this._relatedKey+"["+r+"]."+s,i,t.changed[s],e),i.changed[this._relatedKey+"."+s]=t.changed[s],i.trigger("change:"+this._relatedKey+"."+s,i,t.changed[s],e);i.changed[this._relatedKey]=void 0,i.trigger("change:"+this._relatedKey,i,e),i._triggerParentChange(e)}i.trigger("change",i,e)}},resetRelations:function(t){n.each(this.models,function(e){n.each(e.relations,function(n,i){e.get(i)instanceof h&&e.get(i).trigger("reset",e,t)})})},reset:function(t,e){e||(e={});for(var i=0,r=this.models.length;r>i;i++)this._removeReference(this.models[i]);return e.previousModels=this.models,this._reset(),this.add(t,n.extend({silent:!0},e)),e.silent||(this.trigger("reset",this,e),this.resetRelations(e)),this},comparator:function(t){return t.get("index")},toCompactJSON:function(){var t=n(this.models).map(function(t){return t instanceof u?t.toCompactJSON():t.toJSON()});return t.__proto__=null,t},_prepareModel:function(t,e){if(t instanceof a)return t;e=e?n.clone(e):{},e.collection=this;var i=this.model;t._rel&&this.relations[t._rel]&&(i=this.relations[t._rel]);var r=new i(t,e);return r.validationError?(this.trigger("invalid",this,r.validationError,e),!1):r}}),n.extend(t,{create:function(e,i,r){var r=n.extend({},r,{create:t.create,extend:t.extend,define:t.define});return n.isArray(e)||s(e,a)?t.extend(n.extend({},i,{model:n.isArray(e)?e[0]:e}),r):n.isObject(e)?t.extend(n.extend({},i,{relations:e}),r):t.extend(i,r)},extend:function(){return h.extend.apply(this,arguments)}}),t.define=t.create,t}(),e});